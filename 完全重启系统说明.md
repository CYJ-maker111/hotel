# 完全重启系统功能说明

## 功能描述

点击"加载制冷测试"或"加载制热测试"时，系统会**完全重启**，等同于重新启动程序。

## 实现效果

### 加载测试用例时的行为

```
用户操作：点击"制冷测试"或"制热测试"按钮
系统行为：
  1. 清空所有队列（服务队列、等待队列）
  2. 清空所有计时器（服务计时器、等待计时器）
  3. 清除所有房间的累计费用
  4. 清除所有详单记录
  5. 重置所有房间状态为关机
  6. 重置累计秒数为0
  7. 清除所有内部映射

相当于：程序完全重启 ✓
```

## 清除内容完整列表

| 类别 | 清除项 | 说明 |
|------|--------|------|
| 📋 **队列** | 服务队列 | 清空所有房间 |
| 📋 **队列** | 等待队列 | 清空所有房间 |
| ⏱️ **计时器** | 服务计时器 | 清除所有房间的服务时长 |
| ⏱️ **计时器** | 等待计时器 | 清除所有房间的等待时长 |
| 💰 **费用** | 房间累计费用 | 所有房间费用归零 |
| 📝 **记录** | 详单记录 | 清空数据库中的所有详单 |
| 🏠 **房间状态** | 运行状态 | 所有房间重置为OFF |
| 🏠 **房间状态** | 模式 | 重置为COOL（默认） |
| 🏠 **房间统计** | 服务时长统计 | 清零 |
| 🏠 **房间统计** | 等待时长统计 | 清零 |
| 🧮 **内部状态** | 累计秒数 | 重置为0 |
| 🧮 **内部状态** | 分钟开始温度 | 清空 |
| 🧮 **内部状态** | 详单记录ID映射 | 清空 |

## 保留内容（由测试用例重新设置）

| 项目 | 说明 |
|------|------|
| 🌡️ 房间初始温度 | 由测试用例的"测试初始化"设置 |
| 🌡️ 房间当前温度 | 由测试用例的"测试初始化"设置 |

## 使用场景

### 场景1：连续运行不同模式测试

```bash
# 第一次运行
1. 点击"制热测试" 
   → 系统完全重启 ✓
   → 加载制热用例 ✓
   
2. 运行制热测试
   → 测试完成，费用100元 ✓

# 第二次运行
3. 点击"制冷测试"
   → 系统完全重启 ✓（清除了制热的所有数据）
   → 加载制冷用例 ✓
   
4. 运行制冷测试
   → 从零开始，不受制热影响 ✓
   → 结果与单独运行制冷一致 ✓
```

### 场景2：重复运行同一测试

```bash
1. 运行制冷测试 → 费用80元
2. 点击"制冷测试"（重新加载）
   → 系统完全重启 ✓（清除之前的80元）
3. 再次运行制冷测试
   → 从零开始 ✓
   → 结果与第一次一致 ✓
```

## 控制台输出

加载测试用例时会显示：

```
========== 开始加载制冷测试用例 ==========
正在重置系统状态...
✓ 系统已完全重启（所有状态已清除）
```

## 实现代码

### Scheduler.reset_test_state()

```python
def reset_test_state(self):
    """
    完全重置系统状态 - 相当于重启系统
    清除所有运行状态、队列、计时器、费用、详单记录
    """
    # 1. 清空服务队列和等待队列
    self.served_queue._rooms.clear()
    self.waiting_queue._rooms.clear()
    
    # 2. 清空计时器
    self.service_timer._served_seconds.clear()
    self.wait_timer._waiting_seconds.clear()
    
    # 3. 重置累计秒数和分钟开始温度
    self._accumulated_seconds = 0
    self._minute_start_temps.clear()
    
    # 4. 清除当前详单记录ID映射
    self.current_record_ids.clear()
    
    # 5. 完全重置所有房间状态 - 相当于重启
    for room_id in self.rooms.rooms.keys():
        room = self.rooms.get(room_id)
        room.state = PowerState.OFF
        room.cost = 0.0  # 清除累计费用
        room.total_served_seconds = 0
        room.total_waiting_seconds = 0
        room.mode = Mode.COOL  # 重置为默认模式
```

### HotelACSystem.reset_system()

```python
def reset_system(self):
    """
    完全重启系统 - 清除所有状态和数据
    用于加载新测试用例时彻底重新开始
    """
    # 1. 重置调度器的所有状态
    self.scheduler.reset_test_state()
    
    # 2. 清除所有详单记录 - 完全重启
    self.detail_record.clear_all_records()
    
    print("✓ 系统已完全重启（所有状态已清除）")
```

### 自动调用

```python
# routes/test.py
@test_bp.route('/api/test/load', methods=['GET'])
def load_test_cases():
    from app_context import system
    
    # 在加载新测试用例前，完全重启系统
    print(f"\n========== 开始加载{test_name}测试用例 ==========")
    print("正在重置系统状态...")
    system.reset_system()  # ← 完全重启
    
    # ... 继续解析测试用例
```

## 解决的问题

✅ **彻底解决制热后制冷出错的问题**
- 不会有任何状态遗留
- 每次测试都是全新开始
- 结果完全独立，互不影响

## 注意事项

1. **测试之间互相独立**
   - 每次加载测试用例都会清除所有数据
   - 前一次测试的费用和详单不会保留

2. **如需查看账单**
   - 在运行测试期间查看账单（不要重新加载测试用例）
   - 导出Excel保存账单数据

3. **等同于重启程序**
   - 加载测试用例 = 重启系统
   - 所有状态回到初始状态

## 修改的文件

1. `ac_core/scheduler.py`
   - `reset_test_state()` - 完全重置所有状态
   - `reset_system()` - 调用完全重置
   
2. `hotel/hotel/ac_core/scheduler.py` - 同步更新

## 更新日期
2025年

## 相关文档
- [更新说明.md](./更新说明.md) - 系统功能更新
- [温度范围说明.md](./温度范围说明.md) - 温度范围限制

