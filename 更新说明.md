# 酒店空调系统账单功能更新说明

## 更新日期
2025年

## 主要更新内容

### 1. 入住登记强制验证
- **强制要求填写入住时间**：登记入住时必须填写入住时间，否则显示警告并阻止提交
- **验证提示优化**：使用醒目的图标和颜色提示用户缺失的必填字段
- **输入框高亮**：未填写入住时间时，输入框会红色高亮显示3秒

### 2. 账单类型区分
原有的综合账单功能拆分为两种账单类型：

#### 系统住宿账单（原综合账单）
- 包含住宿费用和空调费用
- 住宿费用 = 房间日租金 × 关机次数（住宿天数）
- 结束时间 = 入住时间 + 天数
- 房间费率：
  - R1: ¥100/天
  - R2: ¥125/天
  - R3: ¥150/天
  - R4: ¥200/天
  - R5: ¥100/天

#### 空调账单（新增）
- 仅显示空调使用费用
- 不计算住宿费用
- 结束时间同样为 入住时间 + 天数

### 3. 账单导出功能
- **删除**：原有的"打印账单"按钮
- **新增**：导出Excel功能
  - 支持导出两种类型的账单（系统住宿账单/空调账单）
  - Excel表格包含：
    - 账单摘要信息
    - 空调使用详单
    - 自动调整列宽
    - 专业的格式和样式

### 4. 前端界面优化
- 在结账界面添加"账单类型"下拉选择框
- 可在查询账单前选择要查看的账单类型
- 账单类型改变时自动刷新显示
- 导出Excel按钮使用醒目的样式

## 技术实现

### 后端API更新

#### 新增接口
1. `GET /api/bills/<room_id>/ac_bill` - 获取空调账单
2. `GET /api/bills/<room_id>/accommodation_bill` - 获取系统住宿账单（原comprehensive接口重命名）
3. `GET /api/bills/<room_id>/export?bill_type=<type>` - 导出Excel账单

#### 修改接口
- `POST /api/rooms/<room_id>/checkin` - 添加入住时间必填验证

### 前端文件更新
- `frontend/index.html` - 添加账单类型选择框，修改按钮
- `frontend/app.js` - 添加入住时间验证、账单类型切换、Excel导出功能

### 依赖更新
新增Python依赖包：
- `openpyxl>=3.0.0` - 用于生成Excel文件

## 安装说明

1. 安装新增的Python依赖：
```bash
pip install openpyxl
```

或使用requirements.txt：
```bash
pip install -r requirements.txt
```

2. 重启后端服务

## 使用说明

### 登记入住
1. 进入"酒店前台界面" -> "登记入住"
2. 选择房间
3. **必须**填写客人姓名和入住时间
4. 可选填写预计退房时间
5. 点击"登记入住"

### 查询和导出账单
1. 进入"酒店前台界面" -> "结账"
2. 选择房间
3. 选择账单类型（系统住宿账单/空调账单）
4. 点击"查询账单"查看
5. 点击"导出Excel"下载账单文件

### 账单说明
- **系统住宿账单**：适用于客人结账时，包含住宿费和空调费的完整账单
- **空调账单**：仅显示空调使用费用，适用于只需要空调费用统计的场景

## 注意事项

1. Excel导出功能需要安装openpyxl库，如未安装会显示错误提示
2. 入住时间为必填项，不填写无法完成登记
3. 结束时间根据入住时间和关机次数自动计算
4. 每次关机视为度过一天，用于计算住宿费用

