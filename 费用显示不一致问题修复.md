# 费用显示不一致问题修复

## 问题描述

房间234的详单账单计算费用和管理员界面显示的费用不一样。

## 问题原因

### 费用来源不同

1. **管理员界面显示的费用**：
   - 来源：`room.cost`（内存中的Room对象）
   - 位置：`scheduler.py` 的 `get_room_status()` 方法
   - 特点：系统重启后会重置为0

2. **详单账单的费用**：
   - 来源：`detail_records` 表的 `SUM(cost)`（数据库）
   - 位置：`records.py` 的 `get_room_total()` 方法
   - 特点：持久化存储，不会因重启而丢失

### 问题场景

```
场景1：系统重启后
- 内存中的 room.cost = 0.0（重置）
- 数据库中的费用 = 100.0（保留）
- 管理员界面显示：0.0 ❌
- 详单账单显示：100.0 ✅
- 结果：不一致！

场景2：费用更新不同步
- room.cost 更新了，但数据库未更新
- 或数据库更新了，但 room.cost 未更新
- 结果：不一致！
```

## 解决方案

**统一使用数据库中的费用作为唯一数据源**

### 修改前

```python
def get_room_status(self, room_id: int) -> Dict:
    room = self.rooms.get(room_id)
    totals = self.detail_record.get_room_total(room_id)
    return {
        ...
        "cost": round(room.cost, 2),  # ❌ 使用内存中的值
        ...
    }
```

### 修改后

```python
def get_room_status(self, room_id: int) -> Dict:
    room = self.rooms.get(room_id)
    totals = self.detail_record.get_room_total(room_id)
    # 使用数据库中的费用，而不是内存中的room.cost
    db_cost = totals.get("total_cost", 0.0)
    return {
        ...
        "cost": round(db_cost, 2),  # ✅ 使用数据库中的值
        ...
    }
```

## 工作原理

### 数据流

```
费用产生
  ↓
更新 room.cost（内存） + 更新 detail_records（数据库）
  ↓
管理员界面查询
  ↓
get_room_status() → get_room_total() → 从数据库读取 ✅
  ↓
显示数据库中的费用（与详单账单一致）
```

### 为什么使用数据库费用？

1. **持久化**：数据库中的费用不会因系统重启而丢失
2. **准确性**：数据库是费用的唯一真实来源
3. **一致性**：与详单账单使用相同的数据源

## 修复效果

### 修复前

```
管理员界面：显示 room.cost = 0.0（内存值）
详单账单：显示 SUM(cost) = 100.0（数据库值）
结果：不一致 ❌
```

### 修复后

```
管理员界面：显示 get_room_total() = 100.0（数据库值）
详单账单：显示 SUM(cost) = 100.0（数据库值）
结果：一致 ✅
```

## 验证方法

### 1. 检查费用一致性

1. 打开管理员界面，查看房间234的费用
2. 打开详单账单，查看房间234的费用
3. 两者应该完全一致

### 2. 测试系统重启

1. 记录当前费用（例如：100.0）
2. 重启系统
3. 检查费用是否保持一致

### 3. 检查数据库

```sql
-- 查看房间234的详单记录
SELECT room_id, SUM(cost) as total_cost 
FROM detail_records 
WHERE room_id = 234;

-- 应该与管理员界面显示的费用一致
```

## 注意事项

### room.cost 的作用

虽然管理员界面不再显示 `room.cost`，但它仍然在内部使用：
- 用于实时计算费用增量
- 用于临时存储当前会话的费用
- 但最终显示时使用数据库中的值

### 性能考虑

每次查询房间状态时都会查询数据库，但：
- SQLite 查询非常快
- 确保数据准确性更重要
- 如果需要优化，可以考虑缓存机制

## 修改的文件

- ✅ `ac_core/scheduler.py` - `get_room_status()` 方法
- ✅ `hotel/ac_core/scheduler.py` - 同步更新

## 相关代码

### get_room_status()

```python
def get_room_status(self, room_id: int) -> Dict:
    room = self.rooms.get(room_id)
    totals = self.detail_record.get_room_total(room_id)  # 从数据库查询
    db_cost = totals.get("total_cost", 0.0)  # 获取数据库中的费用
    return {
        ...
        "cost": round(db_cost, 2),  # 使用数据库费用
        ...
    }
```

### get_room_total()

```python
def get_room_total(self, room_id: int) -> Dict[str, float]:
    # 从数据库查询所有详单记录的费用总和
    cur.execute(
        "SELECT SUM(cost) FROM detail_records WHERE room_id = ?",
        (room_id,),
    )
    cost = row[0] or 0.0
    return {"total_cost": round(float(cost), 2)}
```

## 更新日期
2025年

## 相关文档
- [系统重置功能说明.md](./系统重置功能说明.md) - 系统重置相关
- [详单CSV导出功能说明.md](./详单CSV导出功能说明.md) - 详单导出相关

