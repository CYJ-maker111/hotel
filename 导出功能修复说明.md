# Excel导出功能修复说明

## 问题描述

在导出账单为Excel时出现错误：
```json
{
  "status": "error",
  "message": "导出账单失败：'Response' object is not subscriptable"
}
```

## 问题原因

在 `export_room_bill()` 函数中，代码错误地尝试访问Flask Response对象：

```python
# 错误的代码
if bill_type == 'ac':
    bill_response = get_ac_bill(room_id)
else:
    bill_response = get_accommodation_bill(room_id)

# 尝试像元组一样访问Response对象（错误！）
if bill_response[1] != 200:
    bill_data = bill_response[0].get_json()
```

`get_ac_bill()` 和 `get_accommodation_bill()` 函数返回的是 `jsonify()` 的结果，这是一个Flask Response对象，而不是元组。尝试用 `[0]` 和 `[1]` 访问它会导致 "'Response' object is not subscriptable" 错误。

## 解决方案

不再调用这些函数，而是直接在 `export_room_bill()` 中查询数据库获取账单数据：

```python
# 修复后的代码
# 直接查询数据库获取入住信息
cursor.execute("""
    SELECT guest_name, checkin_time, checkout_time, power_off_count
    FROM checkin_records 
    WHERE room_id = ? AND status = 'CHECKED_IN'
    ...
""", (room_id,))

# 直接构建账单数据字典
if bill_type == 'ac':
    bill_data = {
        "bill_type": "空调账单",
        "room_id": room_id,
        ...
    }
else:
    bill_data = {
        "bill_type": "系统住宿账单",
        "room_id": room_id,
        ...
    }
```

## 修改的文件

1. `hotel/routes/bills.py` - 修复export_room_bill函数
2. `hotel/hotel/routes/bills.py` - 同步更新

## 测试方法

1. 登记入住一个房间
2. 使用空调（开机、调温等操作）
3. 进入"酒店前台界面" -> "结账"
4. 选择房间和账单类型
5. 点击"导出Excel"按钮
6. 应该成功下载Excel文件，不再出现错误

## 验证点

- ✅ 空调账单导出成功
- ✅ 系统住宿账单导出成功  
- ✅ Excel文件包含正确的账单信息
- ✅ Excel文件包含完整的空调使用详单
- ✅ 文件格式正确，可以正常打开

## 更新日期
2025年

## 相关文档
- [更新说明.md](./更新说明.md) - 系统功能更新
- [温度范围说明.md](./温度范围说明.md) - 温度范围限制说明

