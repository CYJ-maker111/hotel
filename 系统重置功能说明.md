# 系统重置功能说明

## 问题描述

在运行完制热测试后再运行制冷测试，结果与单独运行制冷测试不一致。

## 问题原因

加载新测试用例时，系统只重置了测试相关的变量（test_cases、current_minute），但没有重置系统的内部状态，导致：

1. **房间状态遗留**
   - 上次测试的房间模式（COOL/HEAT）没有重置
   - 房间状态（SERVING/WAITING/PAUSED）保留着
   - 累计费用（cost）没有清零

2. **队列状态遗留**
   - 服务队列（served_queue）中还有上次测试的房间
   - 等待队列（waiting_queue）中还有上次测试的房间

3. **计时器状态遗留**
   - 服务计时器（service_timer）保留着上次的计时
   - 等待计时器（wait_timer）保留着上次的计时

4. **其他状态遗留**
   - 累计秒数（_accumulated_seconds）没有重置
   - 分钟开始温度（_minute_start_temps）没有清空
   - 详单记录ID映射（current_record_ids）没有清空

## 解决方案

添加了完整的系统重置功能，在加载新测试用例时自动调用。

### 1. 在 Scheduler 类中添加 `reset_system_state()` 方法

文件：`ac_core/scheduler.py`

```python
def reset_system_state(self):
    """
    重置调度器的所有内部状态
    用于加载新测试用例时清除之前的测试数据
    """
    # 1. 清空服务队列和等待队列
    self.served_queue._rooms.clear()
    self.waiting_queue._rooms.clear()
    
    # 2. 清空计时器
    self.service_timer._served_seconds.clear()
    self.wait_timer._waiting_seconds.clear()
    
    # 3. 重置累计秒数和分钟开始温度
    self._accumulated_seconds = 0
    self._minute_start_temps.clear()
    
    # 4. 清除当前详单记录ID映射
    self.current_record_ids.clear()
    
    # 5. 重置所有房间状态为关机状态
    for room_id in self.rooms.rooms.keys():
        room = self.rooms.get(room_id)
        room.state = PowerState.OFF
        room.cost = 0.0
        room.total_served_seconds = 0
        room.total_waiting_seconds = 0
        # 不重置 initial_temp 和 current_temp，测试用例会设置
```

### 2. 在 HotelACSystem 类中添加 `reset_system()` 方法

文件：`ac_core/scheduler.py`

```python
def reset_system(self):
    """
    重置整个系统状态，用于加载新的测试用例
    清除：队列、计时器、房间状态、详单记录、累计秒数等
    """
    # 重置调度器状态
    self.scheduler.reset_system_state()
    
    # 清除所有详单记录
    self.detail_record.clear_all_records()
    
    print("✓ 系统状态已完全重置")
```

### 3. 在测试加载时调用重置

文件：`routes/test.py`

```python
@test_bp.route('/api/test/load', methods=['GET'])
def load_test_cases():
    """加载并解析测试用例文件"""
    from app_context import system
    
    # 在加载新测试用例前，完全重置系统状态
    print(f"\n========== 开始加载{test_name}测试用例 ==========")
    print("正在重置系统状态...")
    system.reset_system()
    
    # ... 继续解析测试用例
```

## 重置内容清单

系统重置会清除以下内容：

- ✅ 服务队列（served_queue）
- ✅ 等待队列（waiting_queue）
- ✅ 服务计时器（service_timer）
- ✅ 等待计时器（wait_timer）
- ✅ 累计秒数（_accumulated_seconds）
- ✅ 分钟开始温度（_minute_start_temps）
- ✅ 详单记录ID映射（current_record_ids）
- ✅ 所有房间的状态（state → OFF）
- ✅ 所有房间的累计费用（cost → 0.0）
- ✅ 所有房间的服务统计（total_served_seconds、total_waiting_seconds → 0）
- ✅ 所有详单记录（detail_records 表）

## 保留内容

以下内容不会被重置（因为测试用例会重新设置）：

- 房间的初始温度（initial_temp）
- 房间的当前温度（current_temp）
- 房间的模式（mode）- 开机时会设置

## 测试验证

现在可以进行以下测试：

### 场景1：连续运行不同测试
```
1. 运行制热测试 → 完成
2. 加载制冷测试 → 自动重置系统 ✓
3. 运行制冷测试 → 结果应与单独运行制冷一致 ✓
```

### 场景2：重复运行同一测试
```
1. 运行制冷测试 → 完成
2. 重新加载制冷测试 → 自动重置系统 ✓
3. 再次运行制冷测试 → 结果应与第一次一致 ✓
```

### 场景3：中途切换测试
```
1. 运行制热测试到一半
2. 加载制冷测试 → 自动重置系统 ✓
3. 运行制冷测试 → 结果应正常，不受之前影响 ✓
```

## 控制台输出

加载测试用例时，会看到以下输出：

```
========== 开始加载制冷测试用例 ==========
正在重置系统状态...
✓ 系统状态已完全重置
```

## 修改的文件

1. `ac_core/scheduler.py` - 添加 reset_system_state() 和 reset_system()
2. `routes/test.py` - 在 load_test_cases() 中调用 reset_system()
3. `hotel/hotel/ac_core/scheduler.py` - 同步更新
4. `hotel/hotel/routes/test.py` - 同步更新

## 更新日期
2025年

## 相关文档
- [更新说明.md](./更新说明.md) - 系统功能更新
- [温度范围说明.md](./温度范围说明.md) - 温度范围限制
- [导出功能修复说明.md](./导出功能修复说明.md) - Excel导出修复

