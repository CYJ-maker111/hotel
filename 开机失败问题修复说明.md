# 开机失败问题修复说明

## 问题描述

开机时出现"电源切换失败"的错误。

## 问题原因

### 原因1：模式参数格式不匹配

**问题**：
- 后端返回的 `mode` 是 `room.mode.value`，值为小写 `"cool"` 或 `"heat"`
- 客户端直接使用这个值发送给后端
- 后端尝试 `Mode["cool"]` 会失败，因为 `Mode` 枚举的键是大写 `"COOL"` 和 `"HEAT"`

**代码位置**：
```python
# scheduler.py - get_room_status()
return {
    "mode": room.mode.value,  # 返回 "cool" 或 "heat"（小写）
    ...
}

# routes/rooms.py - power_on()
mode = Mode[mode_str]  # 如果mode_str是"cool"，会抛出KeyError
```

### 原因2：异常处理不完善

原来的代码没有捕获 `KeyError` 等异常，导致错误直接抛出。

## 解决方案

### 1. 后端改进（routes/rooms.py）

```python
@rooms_bp.route('/<int:room_id>/power_on', methods=['POST'])
def power_on(room_id: int):
    """房间开机"""
    try:
        data = request.get_json(silent=True) or {}
        # ... 获取房间和温度 ...
        
        # 处理模式参数 - 确保格式正确
        mode_str = data.get('mode', 'COOL')
        if isinstance(mode_str, str):
            mode_str = mode_str.upper()  # 转换为大写
        else:
            mode_str = 'COOL'
        
        # 验证模式值
        if not mode_str or mode_str not in ['COOL', 'HEAT']:
            mode_str = 'COOL'  # 默认使用COOL
        
        # 转换为Mode枚举（带异常处理）
        try:
            mode = Mode[mode_str]
        except KeyError:
            mode = Mode.COOL  # 如果失败，使用默认值
        
        result = system.scheduler.power_on(room_id, current_temp, mode)
        return jsonify(result)
    except Exception as e:
        return jsonify({
            "error": f"开机失败：{str(e)}",
            "message": f"房间{room_id}开机时发生错误"
        }), 500
```

**改进点**：
- ✅ 自动将小写转换为大写
- ✅ 验证模式值是否有效
- ✅ 捕获KeyError异常
- ✅ 添加完整的异常处理

### 2. 客户端改进（room_remote.html）

```javascript
body: JSON.stringify({
    mode: (currentRoomStatus.mode || 'cool').toUpperCase()  // 确保是大写
})
```

**改进点**：
- ✅ 确保发送的模式值是大写（COOL或HEAT）
- ✅ 即使后端返回小写，客户端也会转换为大写

## 修复效果

### 修复前
```
客户端发送：mode: "cool"  (小写)
后端处理：Mode["cool"]  → KeyError ❌
结果：开机失败
```

### 修复后
```
客户端发送：mode: "COOL"  (大写) ✅
后端处理：Mode["COOL"]  → 成功 ✅
结果：开机成功
```

或者即使客户端发送小写：
```
客户端发送：mode: "cool"  (小写)
后端处理：mode_str.upper() → "COOL" → Mode["COOL"]  → 成功 ✅
结果：开机成功
```

## 测试验证

### 测试场景1：正常开机

```bash
1. 选择房间
2. 点击电源按钮开机
3. ✅ 应该成功，不再报错
```

### 测试场景2：模式切换后开机

```bash
1. 房间当前模式是"heat"（小写）
2. 点击电源按钮开机
3. ✅ 应该成功，模式正确设置为HEAT
```

### 测试场景3：异常情况

```bash
1. 发送无效的模式值（如"invalid"）
2. 后端自动使用默认值COOL
3. ✅ 不会报错，正常开机
```

## 错误信息改进

修复后，如果仍然失败，会返回更详细的错误信息：

```json
{
  "error": "开机失败：具体错误信息",
  "message": "房间1开机时发生错误"
}
```

## 修改的文件

1. **后端**
   - `routes/rooms.py` - 添加模式格式转换和异常处理
   - `hotel/hotel/routes/rooms.py` - 同步更新

2. **客户端**
   - `client/room_remote.html` - 确保发送大写的模式值
   - `hotel/hotel/client/room_remote.html` - 同步更新

## 常见问题排查

### Q1: 仍然显示"电源切换失败"

**检查**：
1. 打开浏览器开发者工具（F12）
2. 查看Console标签页的错误信息
3. 查看Network标签页的请求和响应

### Q2: 模式不正确

**检查**：
1. 确认客户端发送的mode是大写（COOL/HEAT）
2. 检查后端日志是否有异常

### Q3: 房间不存在

**检查**：
1. 确认房间ID有效（1-5）
2. 检查系统是否已初始化房间

## 更新日期
2025年

## 相关文档
- [跨机器运行配置说明.md](./跨机器运行配置说明.md) - 网络配置
- [温度范围说明.md](./温度范围说明.md) - 温度限制

