## 酒店自助计费中央空调系统说明文档

### 一、项目简介

本项目实现了一个**快捷廉价酒店自助计费式中央温控系统**的完整解决方案，用于课程/实验作业或原型演示。  
系统支持：

- **房客端功能**：
  - 开关机、制冷/制热模式切换；
  - 设置目标温度（按要求限制在给定范围内）；
  - 调节风速（高 / 中 / 低），并按风速计费；
  - 温度传感与面板显示（通过模拟逻辑实时更新房间温度）。
- **前台/管理员功能**：
  - 查询每个房间当前状态（温度、模式、风速、送风/等待/关机状态等）；
  - 生成退房时的**空调使用账单及汇总信息**；
  - 中央空调管理员可实时监控所有房间运行状态；
  - 酒店经理可查看整体能耗与费用的**统计报表**。

本实现采用 **Python** 编写，使用**面向对象 + 调度器**的方式模拟中央空调系统的行为，重点体现：

- **温控范围与物理模型**；
- **计费与能耗模型**；
- **优先级调度 + 时间片调度**；
- **温度按钮防抖逻辑**。

> 说明：本项目提供了完整的 Web 前后端界面，用户可以通过浏览器直观地操作和监控系统。

---

### 二、需求对应说明

#### 1. 温控范围与模式

- 制冷模式（`Mode.COOL`）：温度范围 **18–25°C**；
- 制热模式（`Mode.HEAT`）：温度范围 **25–30°C**；
- 系统默认温度：`25°C`（常量 `DEFAULT_TEMP`）。

在代码中，目标温度范围限制逻辑集成在温度调节的相关API和界面中。

#### 2. 计费与耗电标准

- **计费标准**：统一计费费率为 `1 元 / 度`。
- **耗电标准**（代码中以“度 / 分钟”为单位）：
  - 高风：`1 度 / 分钟`；
  - 中风：`0.5 度 / 分钟`（即 1 度 / 2 分钟）；
  - 低风：`1/3 度 / 分钟`（即 1 度 / 3 分钟）。

能耗与费用模型在 `Server.update_temperature()` 中实现：

- 每秒能耗 = 温度变化量（℃）；
- 房间对象 `Room` 中记录：
  - `energy_used`：总耗电“度”；
  - `cost`：总费用（`energy_used * 价格`）。

#### 3. 温度变化模式

在 `Server.update_temperature()` 中实现：

- **送风状态（SERVING）**：
  - 高风：`1°C / 分钟`；
  - 中风：`0.5°C / 分钟`；
  - 低风：`1/3°C / 分钟`；
  - 制冷：在当前温度 > 目标温度时降温，不能降过头；
  - 制热：在当前温度 < 目标温度时升温，不能升过头。
- **暂停状态（PAUSED）**：
  - 按 `0.5°C / 分钟` 的速度向目标温度方向回温；
  - 当回温达到 1°C 时，自动重新进入送风状态。
- **关机状态（OFF）**：
  - 按 `0.5°C / 分钟` 的速度向房间 `initial_temp`（初始温度）回归。

#### 4. 自动停止与重启

自动停止与重启逻辑集成在 `Server.update_temperature()` 中：

- **自动停止送风**：
  - 制冷：当 `current_temp <= target_temp` 时，自动进入暂停状态（`PAUSED`）；
  - 制热：当 `current_temp >= target_temp` 时，自动进入暂停状态（`PAUSED`）。
- **自动重启送风**：
  - 制冷模式：当房间处于暂停状态且 `current_temp >= target_temp + 1°C` 时，自动重新进入送风状态（`SERVING`）；
  - 制热模式：当房间处于暂停状态且 `current_temp <= target_temp - 1°C` 时，自动重新进入送风状态（`SERVING`）；
  - 重启时沿用当前房间的 `mode` 与 `fan_speed`。

#### 5. 调度：优先级 + 时间片

在 `Scheduler` 类中实现：

- **服务能力受限**：调度器初始化时传入 `capacity = y`，最多同时服务 y 间房；
- **优先级调度（风速优先）**：
  - `FanSpeed.HIGH > MEDIUM > LOW`；
  - 新送风请求若风速**高于**正在服务的某房间：
    - 通过 `_find_lowest_priority_active()` 找到当前优先级最低的活动请求；
    - 若新请求风速更高，则新请求**立即抢占**其服务：
      - 被抢占房间转入等待队列；
      - 新房间进入 `active_requests`。
- **时间片调度（相同风速轮转）**：
  - 每个请求维护：
    - `total_served_seconds`（累计送风时间）；
    - `waiting_seconds`（自上次开始等待起已等待多久）。
  - 在 `Scheduler.tick()` 中：
    - 每秒更新所有请求的服务/等待时间；
    - 对 `waiting_seconds >= time_slice` 的等待请求：
      - 找出同风速下在服务中、`total_served_seconds` **最长**的房间作为被轮转对象；
      - 被轮转房间进入等待队列；
      - 等待满时间片的房间进入服务队列；
      - 以此实现 **“等待一段时间后（s 秒）获得送风服务，获得服务时间最长的房间被暂停”** 的轮转规则。

#### 6. 风速/温度调整与请求生成规则

- **风速调整**：在 `Server.update_speed()` 中实现：
  - 调节风速视为**新的送风请求**；
  - 将旧请求（若有）移除，提交新的请求给调度器。
- **温度调整**：在 `Server.update_target_temperature()` 中实现：
  - 只改变目标温度，不产生新的送风请求；
  - 仅更新房间对象中的 `target_temp`。

#### 7. 温度按钮防抖逻辑

在 `CommandDebouncer` 类中实现：

- 输入：`List[Tuple[timestamp, value]]`，时间单位为秒，可为 `float`；
- 规则：
  - 若两次指令的时间间隔 `< 1 秒`，只保留该组中**最后一次指令参数**；
  - 若间隔 `>= 1 秒`，则两次请求都保留；
- 输出：过滤后的指令列表，可用于实际发送给服务端。

---

### 三、代码结构与主要类

#### 1. 文件结构

项目采用模块化设计，主要分为以下几个部分：

- **核心模块（ac_core）**：
  - `ac_core/models.py`：定义系统的核心数据模型，包括 `Mode`、`FanSpeed`、`PowerState`、`Room` 等。
  - `ac_core/queues.py`：实现服务队列和等待队列的管理。
  - `ac_core/timers.py`：提供定时器和按钮防抖功能。
  - `ac_core/server.py`：实现温控系统的核心逻辑，包括温度调节、状态管理等。
  - `ac_core/records.py`：处理空调使用详单的记录和持久化。
  - `ac_core/scheduler.py`：实现优先级调度和时间片调度算法。
  - `ac_core/__init__.py`：对外统一导出核心类。

- **后端服务（backend）**：
  - `backend_app.py`：Flask Web 后端的入口文件，提供 REST API 接口。
  - `routes/`：包含所有 API 路由的实现，如房间管理、账单生成、报表统计等。

- **前端界面（frontend）**：
  - `frontend/index.html`：管理员监控界面，用于实时查看和控制所有房间。
  - `frontend/app.js`：前端交互逻辑，处理用户操作和数据展示。
  - `frontend/db_manager.html`：数据库管理界面。
  - `client/room_remote.html`：房客端遥控器界面。

- **数据库**：
  - `hotel_ac.db`：SQLite 数据库，用于存储空调使用记录和账单信息。

- **测试文件**：
  - 多个测试脚本，用于验证系统各功能模块的正确性。

#### 2. 重要接口说明

- **Web 界面使用**（推荐）

  直接通过浏览器访问系统提供的 Web 界面，即可完成所有操作，包括：
  - 房间的开机、关机、模式切换
  - 温度和风速调节
  - 查看房间状态和费用
  - 生成账单和报表

- **后端 API 接口**

  系统提供了 RESTful API 接口，主要包括：
  - `/api/rooms/<room_id>/power_on`：房间开机
  - `/api/rooms/<room_id>/power_off`：房间关机
  - `/api/rooms/<room_id>/adjust_temperature`：调节温度
  - `/api/rooms/<room_id>/adjust_fan_speed`：调节风速
  - `/api/rooms/<room_id>/status`：获取房间状态
  - `/api/bills/<room_id>/detail`：获取房间使用详单
  - `/api/reports/summary`：获取汇总报表

- **核心类接口**（用于二次开发）

  ```python
  from ac_core.server import Server
  from ac_core.models import Mode, FanSpeed
  from ac_core.scheduler import Scheduler

  # 初始化服务器和调度器
  server = Server()
  scheduler = Scheduler(capacity=2)  # 同时服务2个房间
  ```

- **按钮防抖示例**

  ```python
  from ac_core.timers import CommandDebouncer

  # (时间戳, 目标温度)
  raw_cmds = [
      (0.0, 24.0),
      (0.3, 23.0),  # 与上次间隔 < 1 秒，将被合并，只保留 23.0
      (1.5, 22.0),  # 与上次间隔 >= 1 秒，单独发送
  ]
  real_cmds = CommandDebouncer.debounce(raw_cmds)
  ```

---

### 四、运行示例

#### 1. 运行 Web 版前后端

1. 安装依赖：

   ```bash
   pip install flask
   ```

2. 在项目根目录运行后端：

   ```bash
   python backend_app.py
   ```

3. 浏览器访问 `http://127.0.0.1:5000/`，即可看到“酒店自助计费中央空调系统”界面：

   - 左侧为房间列表，显示每个房间的当前状态（温度、模式、风速、状态等）；
   - 右侧为房间操作区，可以对选中房间进行开机、关机、调温、调风速等操作；
   - 管理员可以查看房间的详细使用记录和费用统计；
   - 点击“模拟前进 60 秒”按钮，可推进系统时间，观察温度与费用变化。

4. 房客端界面：

   访问 `http://127.0.0.1:5000/client/room_remote.html`，即可使用房客端遥控器界面。

#### 2. 数据存储

所有操作记录都会被保存到 SQLite 数据库 `hotel_ac.db` 中，主要包括：
- 房间的开关机记录
- 温度和风速调节记录
- 使用时间和费用信息

这些数据可用于生成退房账单和统计报表。


---

### 五、扩展与优化方向（可选）

若作为课程设计或进一步项目，可在本基础上扩展：

- **完善时间范围报表**：按任意时间区间统计不同房间或楼层的能耗；
- **更精细的物理模型**：考虑室外温度、热负荷等因素；
- **异常处理与日志**：记录设备故障、非法操作等；
- **用户认证与授权**：为不同角色（房客、前台、管理员）提供不同的权限控制；
- **实时通知**：当温度异常或系统故障时发送通知；
- **移动端适配**：优化前端界面，使其在移动设备上也能良好显示；
- **数据可视化**：使用图表展示能耗趋势和费用统计。

本项目当前版本侧重于**正确实现题目给出的业务规则与调度算法**，结构清晰，便于进一步扩展和二次开发。


